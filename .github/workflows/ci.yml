name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    environment: auth

    steps:
      # –®–∞–≥ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v3

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ JDK –≤–µ—Ä—Å–∏–∏ 11
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Build and Run Tests
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          ./gradlew build test
        continue-on-error: true

      # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏
      - name: Parse Test Results
        if: always()
        run: |
          echo "üìÑ –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
          if ls build/test-results/test/*.xml 1> /dev/null 2>&1; then
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–µ—Å—Ç–æ–≤
            PASSED=0
            FAILED=0
            SKIPPED=0
            TOTAL=0
            # –ü—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ XML –∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–µ—Å—Ç–æ–≤
            for file in build/test-results/test/*.xml; do
              # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É
              TESTS=$(grep -oP "(?<=<testsuite ).*?(?=>)" "$file" | grep -oP "(?<=tests=\")\d+" | paste -sd+ - | bc)
              FAILURES=$(grep -oP "(?<=<testsuite ).*?(?=>)" "$file" | grep -oP "(?<=failures=\")\d+" | paste -sd+ - | bc)
              SKIPPED=$(grep -oP "(?<=<testsuite ).*?(?=>)" "$file" | grep -oP "(?<=skipped=\")\d+" | paste -sd+ - | bc)
              PASSED_FILE=$((TESTS - FAILURES - SKIPPED))
              PASSED=$((PASSED + PASSED_FILE))
              FAILED=$((FAILED + FAILURES))
              SKIPPED=$((SKIPPED + SKIPPED))
              TOTAL=$((TOTAL + TESTS))
              echo "–§–∞–π–ª: $file"
              echo "‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $PASSED_FILE"
              echo "‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $FAILURES"
              echo "üü° –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $SKIPPED"
              echo "üîπ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TESTS"
            done
            echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
            echo "‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $((PASSED - FAILED - SKIPPED))"
            echo "‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $FAILED"
            echo "üü° –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $SKIPPED"
            echo "üîπ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL"
            echo "üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:*" > test-results.txt
            echo "‚úÖ *–£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:* $((PASSED - FAILED - SKIPPED))" >> test-results.txt
            echo "‚ùå *–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:* $FAILED" >> test-results.txt
            echo "üü° *–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:* $SKIPPED" >> test-results.txt
            echo "üîπ *–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:* $TOTAL" >> test-results.txt
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, —Å–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∏—Ö
            if [ "$FAILED" -gt 0 ]; then
              echo -e "\nüìã *–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:*" >> test-results.txt
              # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
              escape_markdown() {
                local input="$1"
                # –ü—Ä–æ—Å—Ç–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π –≤ Markdown
                echo "$input" | sed -e 's/[&/\]/\\&/g' -e 's/[_*[\]()~`>#+\-=|{}.!]/\\&/g' -e 's/\./\\./g'
              }
              for file in build/test-results/test/*.xml; do
                while read -r testcase; do
                  classname=$(echo "$testcase" | grep -oP 'classname="\K[^"]+')
                  name=$(echo "$testcase" | grep -oP 'name="\K[^"]+')
                  message=$(echo "$testcase" | grep -oP '<failure message=".*?">\K.*?(?=</failure>)' | sed 's/<!\[CDATA\[//;s/\]\]>//')
                  # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                  classname=$(escape_markdown "$classname")
                  name=$(escape_markdown "$name")
                  message=$(escape_markdown "$message")
                  echo -e "üîª *$classname - $name:*\n$message" >> test-results.txt
                done < <(grep -Pzo '<testcase.*?<failure.*?</testcase>' "$file")
              done
            fi
          else
            echo "‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            echo "üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:*" > test-results.txt
            echo "‚ùóÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã." >> test-results.txt
          fi
      # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      - name: Send Telegram Notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.event.pull_request.user.login || github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
        run: |
          echo "üì≤ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –∏–ª–∏ CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
            exit 1
          fi
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
          escape_markdown() {
            local input="$1"
            # –ü—Ä–æ—Å—Ç–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π –≤ Markdown
            echo "$input" | sed -e 's/[&/\]/\\&/g' -e 's/[_*[\]()~`>#+\-=|{}.!]/\\&/g' -e 's/\./\\./g'
          }
          STATUS=$(cat test-results.txt)
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞, –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞ –∏ —Å—Ç–∞—Ç—É—Å–µ
          COMMIT_AUTHOR_ESCAPED=$(escape_markdown "$COMMIT_AUTHOR")
          COMMIT_MESSAGE_ESCAPED=$(escape_markdown "$COMMIT_MESSAGE")
          STATUS_ESCAPED=$(escape_markdown "$STATUS")
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º \n –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
          MESSAGE=$'üèó *–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞*\nüë§ *–ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞:* '"$COMMIT_AUTHOR_ESCAPED"$'\nüí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:* '"$COMMIT_MESSAGE_ESCAPED"$'\n\n'"$STATUS_ESCAPED"
          RESPONSE=$(curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id="$CHAT_ID" \
            -d parse_mode="MarkdownV2" \
            --data-urlencode text="$MESSAGE")
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ."
            echo "–û—Ç–≤–µ—Ç –æ—Ç Telegram API: $RESPONSE"
            exit 1
          fi