name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    environment: auth

    steps:
      # –®–∞–≥ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v3

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ JDK –≤–µ—Ä—Å–∏–∏ 11
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Build and Run Tests
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          ./gradlew build test
        continue-on-error: true

      # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏
      - name: Parse Test Results
        if: always()
        run: |
          echo "üìÑ –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
          if ls build/test-results/test/*.xml 1> /dev/null 2>&1; then
            PASSED=$(grep -oP "(?<=<testsuite ).*?(?=>)" build/test-results/test/*.xml | grep -oP "(?<=tests=\")\d+" | paste -sd+ - | bc)
            FAILED=$(grep -oP "(?<=<testsuite ).*?(?=>)" build/test-results/test/*.xml | grep -oP "(?<=failures=\")\d+" | paste -sd+ - | bc)
            SKIPPED=$(grep -oP "(?<=<testsuite ).*?(?=>)" build/test-results/test/*.xml | grep -oP "(?<=skipped=\")\d+" | paste -sd+ - | bc)
            TOTAL=$((PASSED + FAILED + SKIPPED))
            echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
            echo "‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $((TOTAL - FAILED - SKIPPED))"
            echo "‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $FAILED"
            echo "üü° –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $SKIPPED"
            echo "üîπ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL"
            echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:" > test-results.txt
            echo "‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $((TOTAL - FAILED - SKIPPED))" >> test-results.txt
            echo "‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $FAILED" >> test-results.txt
            echo "üü° –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $SKIPPED" >> test-results.txt
            echo "üîπ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL" >> test-results.txt
          else
            echo "‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:" > test-results.txt
            echo "‚ùóÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã." >> test-results.txt
          fi

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      - name: Send Telegram Notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "üì≤ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –∏–ª–∏ CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
            exit 1
          fi

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–º–º–∏—Ç–µ
          AUTHOR=$(cat commit_info.txt | grep "–ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞" | sed 's/–ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞: //')
          COMMIT_MSG=$(cat commit_info.txt | grep "–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞" | sed 's/–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: //')

          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
          STATUS=$(cat test-results.txt)

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
          MESSAGE="*üèó –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞*
*üë§ –ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞:* $AUTHOR
*üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:* $COMMIT_MSG

*$STATUS*"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
          RESPONSE=$(curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            --data-urlencode text="$MESSAGE" \
            -d parse_mode="Markdown")

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ."
            echo "–û—Ç–≤–µ—Ç –æ—Ç Telegram API: $RESPONSE"
            exit 1
          fi
