name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    environment: auth

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build and Run Tests
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          ./gradlew clean build test
        continue-on-error: true

      - name: Parse Test Results
        if: always()
        run: |
          echo "üìÑ –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
          # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          rm -f test-results.txt

          if ls build/test-results/test/*.xml 1> /dev/null 2>&1; then
            PASSED=$(grep -oP '(?<=tests=")\d+' build/test-results/test/*.xml | paste -sd+ - | bc)
            FAILED=$(grep -oP '(?<=failures=")\d+' build/test-results/test/*.xml | paste -sd+ - | bc)
            SKIPPED=$(grep -oP '(?<=skipped=")\d+' build/test-results/test/*.xml | paste -sd+ - | bc)
            TOTAL=$((PASSED + FAILED + SKIPPED))

            echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
            echo "‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $((PASSED - FAILED - SKIPPED))"
            echo "‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $FAILED"
            echo "üü° –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: $SKIPPED"
            echo "üîπ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL"

            echo "üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:*" > test-results.txt
            echo "‚úÖ *–£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:* $((PASSED - FAILED - SKIPPED))" >> test-results.txt
            echo "‚ùå *–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:* $FAILED" >> test-results.txt
            echo "üü° *–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:* $SKIPPED" >> test-results.txt
            echo "üîπ *–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:* $TOTAL" >> test-results.txt

            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, —Å–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∏—Ö
            if [ "$FAILED" -gt 0 ]; then
              echo -e "\nüìã *–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:*" >> test-results.txt
              for file in build/test-results/test/*.xml; do
                while read -r testcase; do
                  classname=$(echo "$testcase" | grep -oP 'classname="\K[^"]+')
                  name=$(echo "$testcase" | grep -oP 'name="\K[^"]+')
                  message=$(echo "$testcase" | grep -oP '<failure message="\K[^"]+' | sed 's/<!\[CDATA\[//;s/\]\]>//')
                  echo "üîª *$classname - $name:* $message" >> test-results.txt
                done < <(grep -Pzo '<testcase.*?<failure.*?</testcase>' "$file")
              done
            fi
          else
            echo "‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            echo "üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:*" > test-results.txt
            echo "‚ùóÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã." >> test-results.txt
          fi

      - name: Send Telegram Notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.event.pull_request.user.login || github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
        run: |
          echo "üì≤ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –∏–ª–∏ CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
            exit 1
          fi
          STATUS=$(cat test-results.txt)
          MESSAGE="üèó *–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞*\nüë§ *–ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞:* $COMMIT_AUTHOR\nüí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:* $COMMIT_MESSAGE\n\n$STATUS"
          RESPONSE=$(curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id="$CHAT_ID" \
            -d parse_mode="Markdown" \
            --data-urlencode text="$MESSAGE")
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ."
            echo "–û—Ç–≤–µ—Ç –æ—Ç Telegram API: $RESPONSE"
            exit 1
          fi